language: minaml
dist: trusty

services:
  - docker

env:
  global:
    - NAME=openvpn
    - IMAGE=tuimac/openvpn
    - PORT=30001

before_script: cd images/x64

jobs:
  include:
    - stage: 'Run docker container'
      name: 'Run openvpn container'
      script:
        - docker build -t ${IMAGE} . || travis_terminate 1;
        - docker volume create ${NAME} || travis_terminate 1;
        - docker run -itd --name ${NAME} -v ${NAME}:/etc/openvpn -p ${PORT}:1194/udp -p ${PORT}:1194/tcp --cap-add NET_ADMIN --env-file env.list -h ${NAME} --network=bridge ${IMAGE} || travis_terminate 1;
        - sleep 3 || travis_terminate 1;
        - "for i in {0..4}; do curl http://localhost:${PORT}; sleep 10; done || travis_terminate 1;"
        - "[[ $? -ne 0 ]] && { echo 'failure!!'; exit 1; } || travis_terminate 1;"
      after_success:
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin || travis_terminate 1;
        - docker push ${IMAGE} || travis_terminate 1;
